---
title: "Project_Proximity to tourism"
author: "Ranjita"
date: "4/21/2018"
output: 
  html_document:
      keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
#install.packages('ggmap')
#install.packages("dplyr")
#install.packages("plyr")
#install.packages("leaflet")

library(ggmap)
library(dplyr)
library(plyr)
library(leaflet)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r }


library(dplyr)
library(leaflet)
library(ggthemes)
library(ggplot2)
library(plotly)
library(leaflet)
library(readr)
library(RColorBrewer)
library(geosphere)
library(geojsonio)
library(sp)
library(htmltools)
library("ggmap")
library(dplyr)
library(googleway)
library(leaflet)


#Automate for entire dataset

data_replace_mean<- function(data){
  for(i in 1:ncol(data)){
  data[is.na(data[,i]), i] <- mean(data[,i], na.rm = TRUE)
  }
  return(data)
}

listings_col_to_keep = c("id","name","host_id","host_name","host_location","neighbourhood_cleansed","neighbourhood_group_cleansed","city","state","smart_location","latitude","longitude","property_type","room_type","accommodates","bathrooms","bedrooms","beds","price","weekly_price","monthly_price","security_deposit","cleaning_fee","review_scores_rating","review_scores_accuracy","review_scores_cleanliness","review_scores_checkin","review_scores_communication","review_scores_location","review_scores_value","reviews_per_month","host_listings_count","host_total_listings_count","calculated_host_listings_count","availability_365","number_of_reviews")  

df_subset_columns <- function(df){
  df_subset = subset(df,select=listings_col_to_keep)
  df_subset = data_replace_mean(df_subset)
  return(df_subset)
}

clean_data <- function(df){

  df_subset = subset(df,select=listings_col_to_keep)
  df_subset = data_replace_mean(df_subset)
  df_subset$is_commercial = NA


for(i in 1:nrow(df_subset)){
  if((df_subset[i,"calculated_host_listings_count"] > 1)  &  (df_subset[i,"availability_365"]/365 < 0.3) & (df_subset[i,"review_scores_rating"]>50)){
    df_subset[i,"is_commercial"] = "Commercial Listing"  
  }
  else{
    df_subset[i,"is_commercial"] = "Household Listing"
  }
}

df_commercial = subset(df_subset,select = c("id","is_commercial"))
return (df_commercial)
}

listings_file_18 <- read.csv("/Users/ranjitarajeevashetty/Downloads/March_2018/listings_all.csv")


listing_18_commercial <- clean_data(listings_file_18)


#combined_commercial <- rbind(listing_1_commercial,listing_2_commercial)

all_commercial_18 <- filter(listing_18_commercial, is_commercial=="Commercial Listing")

unique_all_commercial_18 <- unique(all_commercial_18$id)

all_non_commercial_18 <- filter(listing_18_commercial,(is_commercial=="Household Listing"))

unique_all_non_commercial_18 <- data.frame(unique(all_non_commercial_18$id))

unique_all_non_commercial_18 <- filter(unique_all_non_commercial_18, !(unique.all_non_commercial_18.id. %in% unique_all_commercial_18))

unique_all_commercial_18 = data.frame(unique_all_commercial_18)

unique_all_commercial_18$is_commercial <- "Commercial Listing"

unique_all_non_commercial_18$is_commercial <- "Household Listing"

colnames(unique_all_commercial_18) = c("id","is_commercial")
colnames(unique_all_non_commercial_18) = c("id","is_commercial")

combined_unique_listings_18 = rbind(unique_all_commercial_18,unique_all_non_commercial_18)
#end

listings_updated_18 = df_subset_columns(listings_file_18)


total_listing = merge(listings_updated_18,combined_unique_listings_18,by="id",all.x = TRUE)#left join

#sapply(var1, tolower), converting to lower

tourist_places_list<-c("bryant park","one world observatory","","The Tour","park slope", "Columbus Circle","Rockefeller Center","United Nations Headquarters","Ellis Island","barclays center","NYC Information Center","The museum of modern art","Elegant Tightwad Shopping Tours","Statue of Liberty","Museum of the Moving Image","New York Botanical Garden","New York Botanical Garden","Lincoln Center", "Bronx Opera House Hotel", "theater for a new audience","Tiffany & Co. Foundation Gallery",
'Chinese Scholars Garden',
'Museum of Sex',
'City Reliquary',
'Staten Island Ferry',
'MCC Theater',
'Century 21',
'Socrates Sculpture Park',
'Wave Hill House',
'Brooklyn History and Pizza Tour',
'LIC Flea',
'Yankee Stadium',
"Brandy's Piano Bar",
'Tenement Museum',
'african burial grounds',
'City Winery',
'the lakeside restaurant',
'Arthur Avenue',
'Flushing Meadows-Corona Park',
'City Island',
'Trinity Church',
'Citi Field',
'Brooklyn Brewery',
'coney island',
'FAO Schwarz',
'230 Fifth',
'The Queens Museum',
'La Marina',
'Brooklyn Bridge',
'Tango House',
'brooklyn historical society',
'Gotham West Market',
'The Metropolitan Museum of Art',
'Brooklyn Museum',
'Empire State Building',
'The Guggenheim Museum',
'Refinery Hotel',
'New York Public Library',
'Jacob K. Javits Center',
'The New Museum',
'Museum of Mathematics',
'Four Freedoms Park ',
'museum of natural history',
'The Staten Island Zoo',
'Green-wood Cemetery'
 )

#tourist_places1<-sapply(tourist_places, tolower)

tourist_places_list_df<-as.data.frame(tourist_places_list)

geo_tourist_places_list<-geocode(as.character(tourist_places_list_df$tourist_places_list))

tourist_places_list_main<-cbind(tourist_places_list_df,geo_tourist_places_list)


filter(tourist_places_list_main, tourist_places_list_main$tourist_places_list == "Columbus Circle") 

tourist_places_list_main$lat[which(tourist_places_list_main$tourist_places_list == "Columbus Circle" )]<-"40.76803"


tourist_places_list_main$lon[which(tourist_places_list_main$tourist_places_list == "Columbus Circle" )]<-"-73.9832"

tourist_places_list_main$lat[which(tourist_places_list_main$tourist_places_list == "one world observatory" )]<-"40.7127"

tourist_places_list_main$lon[which(tourist_places_list_main$tourist_places_list == "one world observatory" )]<-"-74.0134"

tourist_places_list_main$lat[which(tourist_places_list_main$tourist_places_list == "Ellis Island" )]<-"40.6995"

tourist_places_list_main$lon[which(tourist_places_list_main$tourist_places_list == "Ellis Island" )]<-"-74.0396"

tourist_places_list_main$lat[which(tourist_places_list_main$tourist_places_list == "coney island")]<-"40.5755"

tourist_places_list_main$lon[which(tourist_places_list_main$tourist_places_list == "coney island" )]<-"-74.0396"

tourist_places_list_main$lat[which(tourist_places_list_main$tourist_places_list == "Brooklyn Museum")]<-"40.6712"

tourist_places_list_main$lon[which(tourist_places_list_main$tourist_places_list == "Brooklyn Museum" )]<-"-73.9636"

tourist_places_list_main$lat[which(tourist_places_list_main$tourist_places_list == "The Metropolitan Museum of Art")]<-"40.7794"

tourist_places_list_main$lon[which(tourist_places_list_main$tourist_places_list == "The Metropolitan Museum of Art" )]<-"-73.9632"

tourist_places_list_main$lat[which(tourist_places_list_main$tourist_places_list == "Four Freedoms Park")]<-"40.7508"

tourist_places_list_main$lon[which(tourist_places_list_main$tourist_places_list == "Four Freedoms Park" )]<-"-73.9604"

tourist_places_list_main<-filter(tourist_places_list_main, lat != "NA")

tourist_places_list_main$lat<-as.numeric(tourist_places_list_main$lat)

tourist_places_list_main$lon<-as.numeric(tourist_places_list_main$lon)
tourist_places_list_main<-unique(tourist_places_list_main)

#importing march data file

stations_list <- read.csv('/Users/ranjitarajeevashetty/Documents/R-Visualization/R Project/subway.csv', header=TRUE)


#substr('ABC_EFG_HIG_ADF_AKF_MNB', 9, 11)

stations_list$longitude<- as.numeric(substr(stations_list$the_geom, 8, 20))

#stations_list$laltitude<-as.numeric(substr(stations_list$the_geom, 27, 44))

#gsub(" .*$", "",stations_list$the_geom)
d1<-substring(stations_list$the_geom, regexpr(" ", stations_list$the_geom) + 1)
d2<-substring(d1, regexpr(" ", d1) + 1)



d3<-gsub(')','',d2)

latitude<-as.numeric(d3)


stations_list_lat_long<- cbind(stations_list, latitude)



content<- paste("neighbourhood:", total_listing$neighbourhood,"<br/>",
                "neighbourhood_group:", total_listing$neighbourhood_group,"<br/>",
                "room_type:",total_listing$room_type,"<br/>",
                "Availability:", total_listing$availability_365,"<br/>")

library(RColorBrewer)
pal = colorFactor("Set1", domain = total_listing$is_commercial) # Grab a palette
color_offsel1 = pal(total_listing$is_commercial)


#adding subway image

NYU_Subway <- makeIcon(
    iconUrl = "https://images-na.ssl-images-amazon.com/images/I/41NPZ9vZKNL.png",
  iconWidth = 25, iconHeight = 25)


mclust<-leaflet(total_listing)%>%addTiles()%>%addCircleMarkers(color = color_offsel1,popup = content,clusterOptions = markerClusterOptions(), group ="Airbnb Listing" )%>%
  addLegend(pal=pal,values=~total_listing$is_commercial, title = "colour by listing type")%>%setView(-73.9949344, 40.7179112, zoom = 11)%>%addMarkers(data= tourist_places_list_main, group = "Tourist Places",popup = paste("Tourist_place_name:",tourist_places_list_main$tourist_places_list, "<br>"))%>%addMarkers(data= stations_list_lat_long, group = "Subway Station",icon=NYU_Subway)%>%
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$Stamen.TonerLite, group="Toner Lite") %>%
  # Layers control
  addLayersControl(
baseGroups = c("OpenStreetMap", "Toner", "Toner Lite"),
overlayGroups = c("Airbnb Listing","Tourist Places","Subway Station"),
options = layersControlOptions(collapsed = TRUE) )%>%setView(-73.9949344, 40.7179112, zoom = 13)

mclust
#filter by Borough 



# adding route between source and target

#mydf <- data.frame(region = 1:48852,
                   #from_lat = total_listing$longitude,
                   #from_long = total_listing$latitude,
                   #to_lat =total_listing$Nearest_tourist_long ,
                   #to_long = total_listing$Nearest_tourist_lat)

#mykey<- "AIzaSyAiercWjEbY3KeRto570WdpQUDcFTFgOns"

#lapply(1:nrow(mydf), function(x){

    #foo <- google_directions(origin = unlist(mydf[x, 2:3]),
                             #destination = unlist(mydf[x, 4:5]),
                             #key = mykey,
                             #mode = "driving",
                             #simplify = TRUE)

   # pl <- decode_pl(foo$routes$overview_polyline$points)

    #return(pl)
#}
   # ) %>%
#bind_rows(.id = "region") -> temp


#try Later
#polylines <- lapply(1:nrow(mydf), function(x){

  #foo <- google_directions(origin = unlist(mydf[x, 2:3]),
                           #destination = unlist(mydf[x, 4:5]),
                           #key = mykey,
                           #mode = "driving",
                           #simplify = TRUE)

  ## no need to decode the line, just return the string as-is
  #foo$routes$overview_polyline$points
#}
#)

#df <- data.frame(polylines = unlist(polylines), stringsAsFactors = F)

## add some colour values for the markers
#mydf$colour_from <- "red"
#mydf$colour_to <- "blue"

## plot the polylines and the markers
#google_map(key = mapKey) %>%
  #add_markers(data = mydf, lat = "from_lat", lon = "from_long", colour = "colour_from") %>%
  #add_markers(data = mydf, lat = "to_lat", lon = "to_long", colour = "colour_to") %>%
  #add_polylines(data = df, polyline = "polylines")


#unique(total_listing$room_type)












```

```{r }

#install.packages("googleway")

mat <- distm(total_listing[,c('longitude','latitude')], tourist_places_list_main[,c('lon','lat')], fun=distVincentyEllipsoid)


total_listing$Tourist_place <- (tourist_places_list_main$tourist_places_list)[max.col(-mat)]
total_listing$Nearest_tourist_long<- (tourist_places_list_main$lon)[max.col(-mat)]
total_listing$Nearest_tourist_lat<- (tourist_places_list_main$lat)[max.col(-mat)]

total_listing$Min_distance<- apply(mat, 1, min)#apply min function to the matrix per row


#closest 5

#head(order(mat[-1,1]),5)+1


#head(order(mat[1,1]),5)
#mat[1,3]
#mat2=t(apply(mat,1,sort))

#hex

#install.packages("hexbin")

#library(hexbin)

#x=rnorm(total_listing$price)
#y=rnorm(total_listing$Min_distance)
#bin<- hexbin(x,y,xbins = 10)
#plot(bin,main="asd")


#typeof(total_listing$price)
#unique(total_listing$Tourist_place)
#bar plot

tourist_places_8<-total_listing%>%group_by(total_listing$Tourist_place, total_listing$is_commercial)%>%summarise(count=n())

top_places<-c('barclays center',
'Brooklyn Bridge',
'coney island',
'Empire State Building',
'Columbus Circle',
'Rockefeller Center',
'one world observatory',
'United Nations Headquarters')

top_places_df<-as.data.frame(top_places)


#factor(top_places)


names(tourist_places_8)[1]<-"Top_tourist_places"

names(tourist_places_8)[2]<-"is_commercial"
#inner join to filer, merge

top_places_filtrd<-merge(tourist_places_8,top_places_df, by.x= "Top_tourist_places" , by.y = "top_places")

#tourist_places_8%>%filter(tourist_places_8$Top_tourist_places %in% top_places)


tourist_places_8$Top_tourist_places<-as.factor(tourist_places_8$Top_tourist_places)

#which tourist place has maximum no of nearest airbnb listing.

#tourist_top<-head(tourist_places_8,40)

#tourist_places_8[order(-tourist_places_8$count),]

#filter(tourist_places_8,as.character(tourist_places_8$Top_tourist_places)=="Rockefeller Center" )

#typeof(tourist_places_8)

names(top_places_filtrd)[2]<-"Type_of_Listing"

plot2<-ggplot(top_places_filtrd, aes(x=reorder(top_places_filtrd$Top_tourist_places,-count), y =top_places_filtrd$count, fill = Type_of_Listing)) + geom_text(data= top_places_filtrd, mapping = aes(x=reorder(top_places_filtrd$Top_tourist_places,-count), y =top_places_filtrd$count, fill = top_places_filtrd$Type_of_Listing, label=top_places_filtrd$count) ,position = position_dodge(width=0.9),hjust= 0.5,vjust=0,size=3)+
  geom_bar(stat="identity", position = "dodge") +  scale_fill_brewer(palette = "Set1")+labs(subtitle="Tourist place with maximum no of nearest airbnb listing", 
       y="Cont of listing", 
       x="Tourist Places") +theme(axis.text.x = element_text(angle=90, vjust=0.6))

plot2

```

```{r }

#cost variation with tourist palce

total_listing$price <- gsub("[$|,]", "", total_listing$price)

total_listing$price <- as.numeric(total_listing$price)

#cost_airbnb_tourist <-total_listing%>%group_by(Tourist_place)%>%summarise_at()

cost_airbnb_tourist<-aggregate(total_listing[,19],list(total_listing$Tourist_place,total_listing$room_type), mean)

names(cost_airbnb_tourist)[1]<-"Tourist_place"

names(cost_airbnb_tourist)[2]<-"Room_Type"

names(cost_airbnb_tourist)[3]<-"Avg_Price"

cost_airbnb_tourist_10<-head(cost_airbnb_tourist)

top_places_filtrd_cost<-merge(cost_airbnb_tourist,top_places_df, by.x= "Tourist_place" , by.y = "top_places")


plot3<-ggplot(data= top_places_filtrd_cost)+ geom_bar(mapping = aes(x = reorder(Tourist_place,-Avg_Price), y = Avg_Price,fill=Room_Type), stat = "identity",position=position_dodge())+geom_text(data= top_places_filtrd_cost, mapping = aes(x=top_places_filtrd_cost$Tourist_place, y =round(top_places_filtrd_cost$Avg_Price,2), fill = top_places_filtrd_cost$Room_Type, label=round(top_places_filtrd_cost$Avg_Price)) ,position = position_dodge(width=0.9),hjust= 0.5,vjust=0,size=3)+
labs(title= "cost variation with tourist palce", x= "Tourist_place", y = 'Price') + theme(axis.text.x = element_text(angle=90, vjust=0.6))

plot3

```

```{r }

cost_airbnb_tourist<-aggregate(total_listing[,19],list(total_listing$Tourist_place,total_listing$room_type,total_listing$is_commercial), mean)



names(cost_airbnb_tourist)[1]<-"Tourist_place"

names(cost_airbnb_tourist)[2]<-"Room_Type"

names(cost_airbnb_tourist)[3]<-"Listing_Type"

names(cost_airbnb_tourist)[4]<-"Avg_Price"

cost_airbnb_tourist_non_com<-cost_airbnb_tourist%>%filter(cost_airbnb_tourist$Listing_Type=="Household Listing")

cost_airbnb_tourist_com<-cost_airbnb_tourist%>%filter(cost_airbnb_tourist$Listing_Type=="Commercial Listing")

#cost_airbnb_tourist_10<-head(cost_airbnb_tourist_com)

top_places_filtrd_cost_com<-merge(cost_airbnb_tourist_com,top_places_df, by.x= "Tourist_place" , by.y = "top_places")

top_places_filtrd_cost_non_com<-merge(cost_airbnb_tourist_non_com,top_places_df, by.x= "Tourist_place" , by.y = "top_places")


plot3_com<-ggplot(data= top_places_filtrd_cost_com)+ geom_bar(mapping = aes(x = reorder(Tourist_place,-Avg_Price), y = Avg_Price,fill=Room_Type), stat = "identity",position=position_dodge())+geom_text(data= top_places_filtrd_cost_com, mapping = aes(x=top_places_filtrd_cost_com$Tourist_place, y =round(top_places_filtrd_cost_com$Avg_Price,2), fill = top_places_filtrd_cost_com$Room_Type, label=round(top_places_filtrd_cost_com$Avg_Price)) ,position = position_dodge(width=0.9),hjust= 0.5,vjust=0,size=3)+
labs(title= "Airbnb Commercial Listing Cost variation with Tourist palce", x= "Tourist_place", y = 'Price') + theme(axis.text.x = element_text(angle=90, vjust=0.6))



plot3_non_com<-ggplot(data= top_places_filtrd_cost_non_com)+ geom_bar(mapping = aes(x = reorder(Tourist_place,-Avg_Price), y = Avg_Price,fill=Room_Type), stat = "identity",position=position_dodge())+geom_text(data= top_places_filtrd_cost_non_com, mapping = aes(x=top_places_filtrd_cost_non_com$Tourist_place, y =round(top_places_filtrd_cost_non_com$Avg_Price,2), fill = top_places_filtrd_cost_non_com$Room_Type, label=round(top_places_filtrd_cost_non_com$Avg_Price)) ,position = position_dodge(width=0.9),hjust= 0.5,vjust=0,size=3)+
labs(title= "Airbnb Non Commercial Listing Cost variation with Tourist palce", x= "Tourist_place", y = 'Price') + theme(axis.text.x = element_text(angle=90, vjust=0.6))

plot3_com

plot3_non_com
```

```{r}
#min distance for commercial
total_listing_com<-total_listing%>%filter(total_listing$is_commercial=="Commercial Listing")

mat_com <- distm(total_listing_com[,c('longitude','latitude')], tourist_places_list_main[,c('lon','lat')], fun=distVincentyEllipsoid)


total_listing_com$Tourist_place <- (tourist_places_list_main$tourist_places_list)[max.col(-mat_com)]
total_listing_com$Nearest_tourist_long<- (tourist_places_list_main$lon)[max.col(-mat_com)]
total_listing_com$Nearest_tourist_lat<- (tourist_places_list_main$lat)[max.col(-mat_com)]

total_listing_com$Min_distance<- apply(mat_com, 1, min)#apply min function to the matrix per row

total_listing_com_newdf<-total_listing_com[,c("id","name","Tourist_place","Min_distance","is_commercial")]

#names(total_listing_com_newdf)[1]<-"non_com_id"

#names(total_listing_com_newdf)[2]<-"non_com_name"

#names(total_listing_com_newdf)[4]<-"non_com_Min_distance"

#min distance for non commercial
total_listing_noncom<-total_listing%>%filter(total_listing$is_commercial=="Household Listing")

mat_noncom <- distm(total_listing_noncom[,c('longitude','latitude')], tourist_places_list_main[,c('lon','lat')], fun=distVincentyEllipsoid)

total_listing_noncom$Tourist_place <- (tourist_places_list_main$tourist_places_list)[max.col(-mat_noncom)]
total_listing_noncom$Nearest_tourist_long<- (tourist_places_list_main$lon)[max.col(-mat_noncom)]
total_listing_noncom$Nearest_tourist_lat<- (tourist_places_list_main$lat)[max.col(-mat_noncom)]

total_listing_noncom$Min_distance<- apply(mat_noncom, 1, min)#apply min function to the matrix per row

total_listing_noncom_newdf<-total_listing_noncom[,c("id","name","Tourist_place","Min_distance","is_commercial")]


total_listing_min_dist<-rbind(total_listing_com_newdf,total_listing_noncom_newdf)

#merge(total_listing_com_newdf,total_listing_noncom_newdf,by="Tourist_place")

#merge(total_listing_min_dist,tourist_places_list_main,by.x=Tourist_place,by.y=Tourist_place)

total_listing_min_dist_df<-aggregate(total_listing_min_dist[,4],list(total_listing_min_dist$Tourist_place,total_listing_min_dist$is_commercial), min)

names(total_listing_min_dist_df)[1]<-"Tourist_Place"

names(total_listing_min_dist_df)[2]<-"Listing_Type"

names(total_listing_min_dist_df)[3]<-"Minimum_Distance"

total_listing_min_dist_df_mg<-merge(total_listing_min_dist_df,top_places_df,by.x="Tourist_Place",by.y="top_places")

plot4<-ggplot(data= total_listing_min_dist_df_mg)+ geom_bar(mapping = aes(x = reorder(Tourist_Place,-Minimum_Distance), y = Minimum_Distance,fill=Listing_Type), stat = "identity",position=position_dodge())+geom_text(data= total_listing_min_dist_df_mg, mapping = aes(x=total_listing_min_dist_df_mg$Tourist_Place, y =round(total_listing_min_dist_df_mg$Minimum_Distance,2), fill = total_listing_min_dist_df_mg$Listing_Type, label=round(total_listing_min_dist_df_mg$Minimum_Distance)) ,position = position_dodge(width=0.9),hjust= 0.5,vjust=0,size=3)+
labs(title= "Nearest Airbnb to the tourist place", x= "Tourist_place", y = 'Nearest Distnace') + theme(axis.text.x = element_text(angle=90, vjust=0.6))

plot4

#Non commercial is closer dan household




```


```{r}



Rental_Listing <- read.csv("/Users/ranjitarajeevashetty/Documents/R-Visualization/R Project/Rental_LIstings.csv",stringsAsFactors = FALSE
)

#Rental_Listing<-Rental_Listing[!is.na(Rental_Listing[,3:])]

#Rental_Listing[!is.na(Rental_Listing$X2015.01), ]

Rental_Listing_gp <- na.omit(Rental_Listing)


#Rental_Listing_gp<-Rental_Listing %>%group_by(Rental_Listing$Boro)%>%summarize_(mean_price=summarise_all())



#Rental_Listing_gp_flt%>%select(Boro,X2015.01)

#

Rental_Listing_gp<-Rental_Listing_gp %>% group_by(Rental_Listing_gp$Boro) %>% 
  summarise_at(.vars = vars( X2016.01,X2016.02,X2016.03,X2016.04,X2016.05,X2016.06,X2016.07,X2016.08,X2016.09,X2016.10,X2016.11,X2016.12,X2017.01,X2017.02,X2017.03,X2017.04,X2017.05,X2017.06,X2017.07,X2017.08,X2017.09,X2017.10,X2017.11,X2017.12,X2018.01, X2018.02,X2018.03),
                 .funs = c(mean="mean"))


names(Rental_Listing_gp)[1]<-"Boro"

Rental_Listing_gp_flt<-filter(Rental_Listing_gp, 
Rental_Listing_gp$Boro!= "NYC")



library(reshape2)
Rental_Listing_gp_flt<-melt(Rental_Listing_gp_flt, id.vars=c("Boro"))



#airbnb

Price_Occupancy_data<- function(df){

  df<-df[!is.na(df$monthly_price), ]


df<-df[df$monthly_price!="", ]


#total_listing_monthly_price<-total_listing_monthly_price_18[is.na(total_listing$monthly_price), ] 

df$monthly_price <- gsub("[$|,]", "", df$monthly_price)

df$monthly_price <- as.numeric(df$monthly_price )

df<-df %>% group_by(df$neighbourhood_group_cleansed) %>% summarise_at(.vars = vars(monthly_price,availability_30),
                 .funs = c(mean="mean"))

df$availability_30_mean<-round(1-(df$availability_30_mean/30),2)*100

names(df)[1]<-"Boro"

names(df)[2]<-"Monthly_price"

names(df)[3]<-"Occupancy_rate"

return (df)
}

#March18
total_listing_monthly_price_m18 <- read.csv("/Users/ranjitarajeevashetty/Downloads/March_2018/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_m18<-Price_Occupancy_data(total_listing_monthly_price_m18)

#feb18
total_listing_monthly_price_f18 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Feb_2018/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_f18<-Price_Occupancy_data(total_listing_monthly_price_f18)

#Jan18
total_listing_monthly_price_Jan18 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Jan_2018/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Jan18<-Price_Occupancy_data(total_listing_monthly_price_Jan18)

#Dec17
total_listing_monthly_price_Dec17 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Dec_2017/listings_all.csv",stringsAsFactors = FALSE)
total_listing_monthly_price_Dec17<-Price_Occupancy_data(total_listing_monthly_price_Dec17)



#Nov17

total_listing_monthly_price_Nov17 <- read.csv("/Users/ranjitarajeevashetty/Downloads/NOV_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Nov17<-Price_Occupancy_data(total_listing_monthly_price_Nov17)

#Oct17

total_listing_monthly_price_oct17 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Oct_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_oct17<-Price_Occupancy_data(total_listing_monthly_price_oct17)

#Sept 2017
total_listing_monthly_price_Sept17 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Sept_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Sept17<-Price_Occupancy_data(total_listing_monthly_price_Sept17)

#August 2017

total_listing_monthly_price_Aug17 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Aug_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Aug17<-Price_Occupancy_data(total_listing_monthly_price_Aug17)

#Jul 2017
total_listing_monthly_price_Jul2017 <- read.csv("/Users/ranjitarajeevashetty/Downloads/July_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Jul2017<-Price_Occupancy_data(total_listing_monthly_price_Jul2017)

#Jun 2017

total_listing_monthly_price_Jun2017 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Jun_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Jun2017<-Price_Occupancy_data(total_listing_monthly_price_Jun2017)

#May 2017

total_listing_monthly_price_May2017 <- read.csv("/Users/ranjitarajeevashetty/Downloads/May_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_May2017<-Price_Occupancy_data(total_listing_monthly_price_May2017)

#April 2017
total_listing_monthly_price_April2017 <- read.csv("/Users/ranjitarajeevashetty/Downloads/April_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_April2017<-Price_Occupancy_data(total_listing_monthly_price_April2017)

#March 2017
total_listing_monthly_price_March2017 <- read.csv("/Users/ranjitarajeevashetty/Downloads/April_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_March2017<-Price_Occupancy_data(total_listing_monthly_price_March2017)

#Feb 2017
total_listing_monthly_price_Feb2017 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Feb_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Feb2017<-Price_Occupancy_data(total_listing_monthly_price_Feb2017)

#Jan 2017

total_listing_monthly_price_Jan2017 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Jan_2017/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Jan2017<-Price_Occupancy_data(total_listing_monthly_price_Jan2017)

#Dec 2016

total_listing_monthly_price_Dec2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Dec_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Dec2016<-Price_Occupancy_data(total_listing_monthly_price_Dec2016)

#Nov 2016

total_listing_monthly_price_Nov2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Nov_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Nov2016<-Price_Occupancy_data(total_listing_monthly_price_Nov2016)

# Oct 2016
total_listing_monthly_price_Oct2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Nov_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Oct2016<-Price_Occupancy_data(total_listing_monthly_price_Oct2016)

#Sept 2016
total_listing_monthly_price_Sept2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Sept_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Sept2016<-Price_Occupancy_data(total_listing_monthly_price_Sept2016)

#Aug 2016

total_listing_monthly_price_Aug2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Aug_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Aug2016<-Price_Occupancy_data(total_listing_monthly_price_Aug2016)

#jun 2016
total_listing_monthly_price_Jun2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Jun_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Jun2016<-Price_Occupancy_data(total_listing_monthly_price_Jun2016)

total_listing_monthly_price_July2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/July_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_July2016<-Price_Occupancy_data(total_listing_monthly_price_July2016)

#May 2016

total_listing_monthly_price_May2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/May_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_May2016<-Price_Occupancy_data(total_listing_monthly_price_May2016)

#April 2016

total_listing_monthly_price_Apr2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/April_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Apr2016<-Price_Occupancy_data(total_listing_monthly_price_Apr2016)

#March 2016

total_listing_monthly_price_Mar2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/April_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Mar2016<-Price_Occupancy_data(total_listing_monthly_price_Mar2016)

#Feb 2016
total_listing_monthly_price_Feb2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Feb_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Feb2016<-Price_Occupancy_data(total_listing_monthly_price_Feb2016)

#jan 2016
total_listing_monthly_price_Jan2016 <- read.csv("/Users/ranjitarajeevashetty/Downloads/Jan_2016/listings_all.csv",stringsAsFactors = FALSE)

total_listing_monthly_price_Jan2016<-Price_Occupancy_data(total_listing_monthly_price_Jan2016)

#cbind(total_listing_monthly_price_m18,total_listing_monthly_price_f18,total_listing_monthly_price_Jan18,total_listing_monthly_price_Dec17,total_listing_monthly_price_Nov17,total_listing_monthly_price_oct17,total_listing_monthly_price_Sept17,total_listing_monthly_price_Aug17,total_listing_monthly_price_Jul2017,total_listing_monthly_price_Jun2017,total_listing_monthly_price_May2017,total_listing_monthly_price_April2017,total_listing_monthly_price_March2017,total_listing_monthly_price_Feb2017,total_listing_monthly_price_Jan2017,total_listing_monthly_price_Dec2016,total_listing_monthly_price_Nov2016,total_listing_monthly_price_Oct2016,total_listing_monthly_price_Sept2016,total_listing_monthly_price_Aug2016,total_listing_monthly_price_July2016,total_listing_monthly_price_Jun2016,total_listing_monthly_price_May2016,total_listing_monthly_price_Apr2016,total_listing_monthly_price_Mar2016,total_listing_monthly_price_Feb2016,total_listing_monthly_price_Jan2016)

total_listing_monthly_price_TS<-cbind(total_listing_monthly_price_m18,total_listing_monthly_price_f18$Monthly_price,total_listing_monthly_price_f18$Occupancy_rate,total_listing_monthly_price_Jan18$Monthly_price,total_listing_monthly_price_Jan18$Occupancy_rate,total_listing_monthly_price_Dec17$Monthly_price,total_listing_monthly_price_Dec17$Occupancy_rate,total_listing_monthly_price_Nov17$Monthly_price,total_listing_monthly_price_Nov17$Occupancy_rate,total_listing_monthly_price_oct17$Monthly_price,total_listing_monthly_price_oct17$Occupancy_rate,total_listing_monthly_price_Sept17$Monthly_price,total_listing_monthly_price_Sept17$Occupancy_rate,total_listing_monthly_price_Aug17$Monthly_price,total_listing_monthly_price_Aug17$Occupancy_rate,total_listing_monthly_price_Jul2017$Monthly_price,total_listing_monthly_price_Jul2017$Occupancy_rate,total_listing_monthly_price_Jun2017$Monthly_price,total_listing_monthly_price_Jun2017$Occupancy_rate,total_listing_monthly_price_May2017$Monthly_price,total_listing_monthly_price_May2017$Occupancy_rate,total_listing_monthly_price_April2017$Monthly_price,total_listing_monthly_price_April2017$Occupancy_rate,total_listing_monthly_price_March2017$Monthly_price,total_listing_monthly_price_March2017$Occupancy_rate,total_listing_monthly_price_Feb2017$Monthly_price,total_listing_monthly_price_Feb2017$Occupancy_rate,total_listing_monthly_price_Jan2017$Monthly_price,total_listing_monthly_price_Jan2017$Occupancy_rate,total_listing_monthly_price_Dec2016$Monthly_price,total_listing_monthly_price_Dec2016$Occupancy_rate,total_listing_monthly_price_Nov2016$Monthly_price,total_listing_monthly_price_Nov2016$Occupancy_rate,total_listing_monthly_price_Oct2016$Monthly_price,total_listing_monthly_price_Oct2016$Occupancy_rate,total_listing_monthly_price_Sept2016$Monthly_price,total_listing_monthly_price_Sept2016$Occupancy_rate,total_listing_monthly_price_Aug2016$Monthly_price,total_listing_monthly_price_Aug2016$Occupancy_rate,total_listing_monthly_price_July2016$Monthly_price,total_listing_monthly_price_July2016$Occupancy_rate,total_listing_monthly_price_Jun2016$Monthly_price,total_listing_monthly_price_Jun2016$Occupancy_rate,total_listing_monthly_price_May2016$Monthly_price,total_listing_monthly_price_May2016$Occupancy_rate,total_listing_monthly_price_Apr2016$Monthly_price,total_listing_monthly_price_Apr2016$Occupancy_rate,total_listing_monthly_price_Mar2016$Monthly_price,total_listing_monthly_price_Mar2016$Occupancy_rate,total_listing_monthly_price_Feb2016$Monthly_price,total_listing_monthly_price_Feb2016$Occupancy_rate,total_listing_monthly_price_Jan2016$Monthly_price,total_listing_monthly_price_Jan2016$Occupancy_rate)

names(total_listing_monthly_price_TS)[2]<-"Mar'18"
names(total_listing_monthly_price_TS)[3]<-"Mar-18"
names(total_listing_monthly_price_TS)[4]<-"Feb'18"
names(total_listing_monthly_price_TS)[5]<-"Feb-18" #occupancy
names(total_listing_monthly_price_TS)[6]<-"Jan'18"
names(total_listing_monthly_price_TS)[7]<-"Jan-18"
names(total_listing_monthly_price_TS)[8]<-"Dec'17"
names(total_listing_monthly_price_TS)[9]<-"Dec-17"
names(total_listing_monthly_price_TS)[10]<-"Nov'17"
names(total_listing_monthly_price_TS)[11]<-"Nov-17"
names(total_listing_monthly_price_TS)[12]<-"Oct'17"
names(total_listing_monthly_price_TS)[13]<-"Oct-17"
names(total_listing_monthly_price_TS)[14]<-"Sep'17"
names(total_listing_monthly_price_TS)[15]<-"Sep-17"
names(total_listing_monthly_price_TS)[16]<-"Aug'17"
names(total_listing_monthly_price_TS)[17]<-"Aug-17"
names(total_listing_monthly_price_TS)[18]<-"Jul'17"
names(total_listing_monthly_price_TS)[19]<-"Jul-17"
names(total_listing_monthly_price_TS)[20]<-"Jun'17"
names(total_listing_monthly_price_TS)[21]<-"Jun-17"
names(total_listing_monthly_price_TS)[22]<-"May'17"
names(total_listing_monthly_price_TS)[23]<-"May-17"
names(total_listing_monthly_price_TS)[24]<-"Apr'17"
names(total_listing_monthly_price_TS)[25]<-"Apr-17"
names(total_listing_monthly_price_TS)[26]<-"Mar'17"
names(total_listing_monthly_price_TS)[27]<-"Mar-17"
names(total_listing_monthly_price_TS)[28]<-"Feb'17"
names(total_listing_monthly_price_TS)[29]<-"Feb-17"
names(total_listing_monthly_price_TS)[30]<-"Jan'17"
names(total_listing_monthly_price_TS)[31]<-"Jan-17"
names(total_listing_monthly_price_TS)[32]<-"Dec'16"
names(total_listing_monthly_price_TS)[33]<-"Dec-16"
names(total_listing_monthly_price_TS)[34]<-"Nov'16"
names(total_listing_monthly_price_TS)[35]<-"Nov-16"
names(total_listing_monthly_price_TS)[36]<-"Oct'16"
names(total_listing_monthly_price_TS)[37]<-"Oct-16"
names(total_listing_monthly_price_TS)[38]<-"Sept'16"
names(total_listing_monthly_price_TS)[39]<-"Sept-16"
names(total_listing_monthly_price_TS)[40]<-"Aug'16"
names(total_listing_monthly_price_TS)[41]<-"Aug-16"
names(total_listing_monthly_price_TS)[42]<-"Jul'16"
names(total_listing_monthly_price_TS)[43]<-"Jul-16"
names(total_listing_monthly_price_TS)[44]<-"Jun'16"
names(total_listing_monthly_price_TS)[45]<-"Jun-16"
names(total_listing_monthly_price_TS)[46]<-"May'16"
names(total_listing_monthly_price_TS)[47]<-"May-16"
names(total_listing_monthly_price_TS)[48]<-"Apr'16"
names(total_listing_monthly_price_TS)[49]<-"Apr-16"
names(total_listing_monthly_price_TS)[50]<-"Mar'16"
names(total_listing_monthly_price_TS)[51]<-"Mar-16"
names(total_listing_monthly_price_TS)[52]<-"Feb'16"
names(total_listing_monthly_price_TS)[53]<-"Feb-16"
names(total_listing_monthly_price_TS)[54]<-"Jan'16"
names(total_listing_monthly_price_TS)[55]<-"Jan-16"

#median price

total_listing_monthly_price_mprice<-total_listing_monthly_price_TS[,c("Boro","Mar'18","Feb'18","Jan'18","Dec'17","Nov'17","Oct'17","Sep'17","Aug'17","Jul'17","Jun'17","May'17","Apr'17","Mar'17","Feb'17","Jan'17","Dec'16","Nov'16","Oct'16","Sept'16","Aug'16","Jul'16","Jun'16","May'16","Apr'16","Mar'16","Feb'16","Jan'16")]

#occupancy

total_listing_monthly_occupancy_mprice<-total_listing_monthly_price_TS[,c("Boro","Mar-18","Feb-18","Jan-18","Dec-17","Nov-17","Oct-17","Sep-17","Aug-17","Jul-17","Jun-17","May-17","Apr-17","Mar-17","Feb-17","Jan-17","Dec-16","Nov-16","Oct-16","Sept-16","Aug-16","Jul-16","Jun-16","May-16","Apr-16","Mar-16","Feb-16","Jan-16")]

#Median Price
library(reshape2)
total_listing_monthly_price_mprice_mel<-melt(total_listing_monthly_price_mprice, id.vars=c("Boro"))

#Occupancy
library(reshape2)
total_listing_monthly_occupancy_mprice_mel<-melt(total_listing_monthly_occupancy_mprice, id.vars=c("Boro"))


names(total_listing_monthly_occupancy_mprice_mel)[2]<-"Time_Period"

names(total_listing_monthly_occupancy_mprice_mel)[3]<-"Occupancy_rate"

# combining Rental and airbnb dataframe for price 

Combined_rental_airbnb<-cbind(total_listing_monthly_price_mprice_mel,Rental_Listing_gp_flt$value)

names(Combined_rental_airbnb)[4]<-"Rental_Prices"

names(Combined_rental_airbnb)[3]<-"Airbnb_Prices"

#Rental and airbnb dataframe for Occupancy 

Rental_Listing_avail <- read.csv("/Users/ranjitarajeevashetty/Documents/R-Visualization/R Project/Rental_Avail.csv",stringsAsFactors = FALSE
)

#Rental_Listing<-Rental_Listing[!is.na(Rental_Listing[,3:])]

#Rental_Listing_avail[!is.na(Rental_Listing_avail$X2016.01), ]

#Rental_Listing_avail <- na.omit(Rental_Listing)
Rental_Listing_avail[is.na(Rental_Listing_avail)]<- 0



Rental_Listing_avail_gp<-Rental_Listing_avail %>% group_by(Rental_Listing_avail$Boro) %>% 
  summarise_at(.vars = vars( X2016.01,X2016.02,X2016.03,X2016.04,X2016.05,X2016.06,X2016.07,X2016.08,X2016.09,X2016.10,X2016.11,X2016.12,X2017.01,X2017.02,X2017.03,X2017.04,X2017.05,X2017.06,X2017.07,X2017.08,X2017.09,X2017.10,X2017.11,X2017.12,X2018.01, X2018.02,X2018.03),
                 .funs = c(mean="mean"))

Rental_Listing_avail_gp[, 2:ncol(Rental_Listing_avail_gp)]<- (1-(Rental_Listing_avail_gp[, 2:ncol(Rental_Listing_avail_gp)]/12/30))*100

#Rental_Listing_avail_gp[, 2:ncol(Rental_Listing_avail_gp)]<- Rental_Listing_avail_gp[, 2:ncol(Rental_Listing_avail_gp)]


names(Rental_Listing_avail_gp)[1]<-"Boro"

Rental_Listing_avail_gp_flt<-filter(Rental_Listing_avail_gp, 
Rental_Listing_avail_gp$Boro!= "NYC")


library(reshape2)
Rental_Listing_avail_gp_flt<-melt(Rental_Listing_avail_gp_flt, id.vars=c("Boro"))



names(Rental_Listing_avail_gp_flt)[2]<-"Time_Period"

names(Rental_Listing_avail_gp_flt)[3]<-"Median_Occupancy_rate"

#combined dataframe for occupancy




Combined_occupancy_airbnb<-cbind(total_listing_monthly_occupancy_mprice_mel,Rental_Listing_avail_gp_flt$Median_Occupancy_rate)

names(Combined_occupancy_airbnb)[3]<-"Airbnb_Occupancy_Rate"

names(Combined_occupancy_airbnb)[4]<-"Rental_Occupancy_Rate"
  
# plotly


#time vs price
plot_ly(Combined_rental_airbnb, x = ~Time_Period , y = ~Airbnb_Prices, name='Airbnb',type = 'scatter', mode='lines',
              color = ~Boro)%>%add_trace(y=~Rental_Prices, name='Rentals',type = 'scatter', mode='lines', line=list(width= 4,dash='dot') )%>%layout(xaxis=list(title="",tickangle=45 ),yaxis=list(title="Median Price"))

#ime vs Occupancy
plot_ly(Combined_occupancy_airbnb, x = ~Time_Period , y = ~Airbnb_Occupancy_Rate, name='Airbnb',type = 'scatter', mode='lines',
              color = ~Boro)%>%add_trace(y=~Rental_Occupancy_Rate, name='Rentals',type = 'scatter', mode='lines', line=list(width= 4,dash='dot') )%>%layout(xaxis=list(title="",tickangle=45 ),yaxis=list(title="Occupancy Rate"))





   
```






## Including Plots

You can also embed plots, for example:



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
